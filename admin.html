<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发票管理系统 - 管理员</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#dbeafe',
                        neutral: '#f8fafc',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'button': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .form-input-focus {
                @apply focus:ring-2 focus:ring-primary focus:border-primary focus:outline-none;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-all duration-300 shadow-button focus:ring-2 focus:ring-primary/50 focus:outline-none;
            }
            .btn-secondary {
                @apply bg-white text-primary border border-primary px-4 py-2 rounded-md hover:bg-accent transition-all duration-300 shadow-button focus:ring-2 focus:ring-primary/50 focus:outline-none;
            }
            .btn-danger {
                @apply bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-all duration-300 shadow-button focus:ring-2 focus:ring-red-500/50 focus:outline-none;
            }
            .card {
                @apply bg-white rounded-lg shadow-card p-6 transition-all duration-300 hover:shadow-lg;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .form-input {
                @apply w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus transition-all duration-300;
            }
            .badge {
                @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
            }
            .badge-blue {
                @apply bg-blue-100 text-blue-800;
            }
            .badge-green {
                @apply bg-green-100 text-green-800;
            }
            .badge-yellow {
                @apply bg-yellow-100 text-yellow-800;
            }
            .badge-red {
                @apply bg-red-100 text-red-800;
            }
            .table-header {
                @apply px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
            }
            .table-cell {
                @apply px-6 py-4 whitespace-nowrap text-sm text-gray-900;
            }
            .table-row {
                @apply hover:bg-gray-50 transition-colors;
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .slide-in {
                animation: slideIn 0.3s ease-in-out;
            }
            @keyframes slideIn {
                from { transform: translateX(-100%); }
                to { transform: translateX(0); }
            }
            .pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-file-text-o text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800">发票管理系统</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">管理员模式</span>
                <a href="index.html" class="btn-secondary text-sm">
                    <i class="fa fa-arrow-left mr-1"></i> 返回表单
                </a>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 统计卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">总提交数</p>
                        <h3 id="totalSubmissions" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fa fa-file-text-o text-primary text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span id="submissionTrend" class="text-sm font-medium text-green-600">
                            <i class="fa fa-arrow-up mr-1"></i> 0%
                        </span>
                        <span class="text-sm text-gray-500 ml-2">较上周</span>
                    </div>
                </div>
            </div>
            
            <div class="card fade-in" style="animation-delay: 0.1s;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">总金额</p>
                        <h3 id="totalAmount" class="text-2xl font-bold text-gray-800">¥0.00</h3>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fa fa-money text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span id="amountTrend" class="text-sm font-medium text-green-600">
                            <i class="fa fa-arrow-up mr-1"></i> 0%
                        </span>
                        <span class="text-sm text-gray-500 ml-2">较上周</span>
                    </div>
                </div>
            </div>
            
            <div class="card fade-in" style="animation-delay: 0.2s;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">提交部门数</p>
                        <h3 id="departmentCount" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fa fa-users text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span class="text-sm text-gray-500">活跃部门</span>
                    </div>
                </div>
            </div>
            
            <div class="card fade-in" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">今日提交</p>
                        <h3 id="todaySubmissions" class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fa fa-calendar-check-o text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex items-center">
                        <span id="todayAmount" class="text-sm font-medium text-gray-600">
                            总计 ¥0.00
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表和数据表格 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- 部门分布图 -->
            <div class="card lg:col-span-1 fade-in">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">部门分布</h3>
                <div class="h-64">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
            
            <!-- 金额趋势图 -->
            <div class="card lg:col-span-2 fade-in" style="animation-delay: 0.1s;">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">金额趋势</h3>
                <div class="h-64">
                    <canvas id="amountChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="card fade-in" style="animation-delay: 0.2s;">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 md:mb-0">发票数据列表</h3>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <!-- 搜索框 -->
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="form-input pl-10" 
                            placeholder="搜索姓名、部门..."
                        >
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    
                    <!-- 筛选 -->
                    <select id="filterDepartment" class="form-input">
                        <option value="">所有部门</option>
                        <option value="财务部">财务部</option>
                        <option value="人力资源部">人力资源部</option>
                        <option value="市场部">市场部</option>
                        <option value="技术部">技术部</option>
                        <option value="行政部">行政部</option>
                        <option value="销售部">销售部</option>
                        <option value="其他">其他</option>
                    </select>
                    
                    <!-- 导出按钮 -->
                    <div class="flex space-x-2">
                        <button id="exportCsv" class="btn-secondary text-sm">
                            <i class="fa fa-download mr-1"></i> CSV
                        </button>
                        <button id="exportExcel" class="btn-primary text-sm">
                            <i class="fa fa-file-excel-o mr-1"></i> Excel
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 表格容器 -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="table-header">
                                <div class="flex items-center">
                                    <input type="checkbox" id="selectAll" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                    <label for="selectAll" class="sr-only">选择所有</label>
                                </div>
                            </th>
                            <th scope="col" class="table-header">
                                <div class="flex items-center">
                                    <span>提交时间</span>
                                    <button class="ml-1 sort-btn" data-sort="date">
                                        <i class="fa fa-sort text-gray-400"></i>
                                    </button>
                                </div>
                            </th>
                            <th scope="col" class="table-header">
                                <div class="flex items-center">
                                    <span>姓名</span>
                                    <button class="ml-1 sort-btn" data-sort="name">
                                        <i class="fa fa-sort text-gray-400"></i>
                                    </button>
                                </div>
                            </th>
                            <th scope="col" class="table-header">
                                <div class="flex items-center">
                                    <span>部门</span>
                                    <button class="ml-1 sort-btn" data-sort="department">
                                        <i class="fa fa-sort text-gray-400"></i>
                                    </button>
                                </div>
                            </th>
                            <th scope="col" class="table-header">
                                <div class="flex items-center">
                                    <span>金额</span>
                                    <button class="ml-1 sort-btn" data-sort="amount">
                                        <i class="fa fa-sort text-gray-400"></i>
                                    </button>
                                </div>
                            </th>
                            <th scope="col" class="table-header">文件</th>
                            <th scope="col" class="table-header">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
                        <!-- 表格数据将通过 JavaScript 动态生成 -->
                        <tr class="text-center">
                            <td colspan="7" class="py-12 text-gray-500">
                                <div class="flex flex-col items-center">
                                    <i class="fa fa-folder-open-o text-4xl mb-2"></i>
                                    <p>暂无数据</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div class="flex items-center justify-between mt-6">
                <div class="text-sm text-gray-700">
                    显示 <span id="showingRange">0-0</span> 条，共 <span id="totalCount">0</span> 条
                </div>
                <div class="flex space-x-2">
                    <button id="prevPage" class="btn-secondary text-sm" disabled>
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <button id="nextPage" class="btn-secondary text-sm" disabled>
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 批量操作 -->
        <div id="batchActions" class="fixed bottom-6 right-6 hidden">
            <div class="bg-white rounded-lg shadow-lg p-4 slide-in">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium text-gray-800">批量操作</h4>
                    <button id="closeBatch" class="text-gray-400 hover:text-gray-600">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button id="batchExport" class="btn-primary text-sm">
                        <i class="fa fa-download mr-1"></i> 导出选中
                    </button>
                    <button id="batchDelete" class="btn-danger text-sm">
                        <i class="fa fa-trash mr-1"></i> 删除选中
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 底部信息 -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-gray-600 text-sm">
                <p>© 2025 发票管理系统 | 管理员界面</p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // 全局变量
        let formData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let sortField = 'timestamp';
        let sortDirection = 'desc';
        let selectedItems = new Set();
        let departmentChart = null;
        let amountChart = null;

        // DOM 元素
        const dataTable = document.getElementById('dataTable');
        const searchInput = document.getElementById('searchInput');
        const filterDepartment = document.getElementById('filterDepartment');
        const selectAllCheckbox = document.getElementById('selectAll');
        const batchActions = document.getElementById('batchActions');
        const closeBatchBtn = document.getElementById('closeBatch');
        const batchExportBtn = document.getElementById('batchExport');
        const batchDeleteBtn = document.getElementById('batchDelete');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const showingRangeSpan = document.getElementById('showingRange');
        const totalCountSpan = document.getElementById('totalCount');
        const exportCsvBtn = document.getElementById('exportCsv');
        const exportExcelBtn = document.getElementById('exportExcel');
        
        // 统计元素
        const totalSubmissionsSpan = document.getElementById('totalSubmissions');
        const totalAmountSpan = document.getElementById('totalAmount');
        const departmentCountSpan = document.getElementById('departmentCount');
        const todaySubmissionsSpan = document.getElementById('todaySubmissions');
        const todayAmountSpan = document.getElementById('todayAmount');
        const submissionTrendSpan = document.getElementById('submissionTrend');
        const amountTrendSpan = document.getElementById('amountTrend');

        // 初始化
        function init() {
            // 加载本地存储的数据
            loadFormData();
            
            // 绑定事件
            bindEvents();
            
            // 初始化图表
            initCharts();
            
            // 渲染数据
            renderData();
            
            // 更新统计信息
            updateStatistics();
        }

        // 绑定事件
        function bindEvents() {
            // 搜索和筛选
            searchInput.addEventListener('input', handleSearch);
            filterDepartment.addEventListener('change', handleFilter);
            
            // 排序
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const field = btn.getAttribute('data-sort');
                    handleSort(field);
                });
            });
            
            // 全选
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            
            // 批量操作
            closeBatchBtn.addEventListener('click', () => {
                batchActions.classList.add('hidden');
            });
            
            batchExportBtn.addEventListener('click', handleBatchExport);
            batchDeleteBtn.addEventListener('click', handleBatchDelete);
            
            // 分页
            prevPageBtn.addEventListener('click', handlePrevPage);
            nextPageBtn.addEventListener('click', handleNextPage);
            
            // 导出
            exportCsvBtn.addEventListener('click', () => exportData('csv'));
            exportExcelBtn.addEventListener('click', () => exportData('excel'));
        }

        // 加载表单数据
        function loadFormData() {
            try {
                formData = JSON.parse(localStorage.getItem('invoiceFormData')) || [];
                // 确保数据有正确的格式
                formData = formData.map(item => ({
                    id: item.id || generateId(),
                    name: item.name || '',
                    department: item.department || '',
                    amount: parseFloat(item.amount) || 0,
                    date: item.date || new Date().toISOString().split('T')[0],
                    notes: item.notes || '',
                    fileName: item.fileName || '',
                    fileType: item.fileType || '',
                    fileSize: item.fileSize || 0,
                    timestamp: item.timestamp || new Date().toISOString()
                }));
            } catch (error) {
                console.error('加载数据失败:', error);
                formData = [];
            }
        }

        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 处理搜索
        function handleSearch() {
            currentPage = 1;
            renderData();
            updatePagination();
        }

        // 处理筛选
        function handleFilter() {
            currentPage = 1;
            renderData();
            updatePagination();
        }

        // 处理排序
        function handleSort(field) {
            if (sortField === field) {
                // 切换排序方向
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                // 新的排序字段
                sortField = field;
                sortDirection = 'asc';
            }
            
            // 更新排序图标
            document.querySelectorAll('.sort-btn').forEach(btn => {
                const icon = btn.querySelector('i');
                if (btn.getAttribute('data-sort') === field) {
                    icon.className = sortDirection === 'asc' ? 
                        'fa fa-sort-asc text-primary' : 
                        'fa fa-sort-desc text-primary';
                } else {
                    icon.className = 'fa fa-sort text-gray-400';
                }
            });
            
            renderData();
        }

        // 处理全选
        function handleSelectAll() {
            const isChecked = selectAllCheckbox.checked;
            const currentPageItems = getCurrentPageItems();
            
            if (isChecked) {
                // 选中当前页所有项目
                currentPageItems.forEach(item => {
                    selectedItems.add(item.id);
                });
            } else {
                // 取消选中当前页所有项目
                currentPageItems.forEach(item => {
                    selectedItems.delete(item.id);
                });
            }
            
            // 更新表格中的复选框
            updateRowCheckboxes();
            
            // 显示或隐藏批量操作
            toggleBatchActions();
        }

        // 更新行复选框
        function updateRowCheckboxes() {
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const id = checkbox.getAttribute('data-id');
                checkbox.checked = selectedItems.has(id);
            });
        }

        // 切换批量操作显示
        function toggleBatchActions() {
            if (selectedItems.size > 0) {
                batchActions.classList.remove('hidden');
            } else {
                batchActions.classList.add('hidden');
            }
        }

        // 处理批量导出
        function handleBatchExport() {
            if (selectedItems.size === 0) return;
            
            const selectedData = formData.filter(item => selectedItems.has(item.id));
            exportData('excel', selectedData);
        }

        // 处理批量删除
        function handleBatchDelete() {
            if (selectedItems.size === 0) return;
            
            if (confirm(`确定要删除选中的 ${selectedItems.size} 条记录吗？此操作不可恢复。`)) {
                // 从数据中删除选中项
                formData = formData.filter(item => !selectedItems.has(item.id));
                
                // 保存到本地存储
                saveFormData();
                
                // 清空选中项
                selectedItems.clear();
                
                // 隐藏批量操作
                batchActions.classList.add('hidden');
                
                // 重新渲染数据
                renderData();
                
                // 更新统计信息
                updateStatistics();
                
                // 更新图表
                updateCharts();
            }
        }

        // 处理上一页
        function handlePrevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderData();
                updatePagination();
            }
        }

        // 处理下一页
        function handleNextPage() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderData();
                updatePagination();
            }
        }

        // 获取当前页的数据
        function getCurrentPageItems() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            return filteredData.slice(startIndex, endIndex);
        }

        // 渲染数据表格
        function renderData() {
            // 应用搜索和筛选
            filteredData = applyFilters();
            
            // 应用排序
            filteredData.sort((a, b) => {
                let aValue, bValue;
                
                switch (sortField) {
                    case 'name':
                        aValue = a.name.toLowerCase();
                        bValue = b.name.toLowerCase();
                        break;
                    case 'department':
                        aValue = a.department.toLowerCase();
                        bValue = b.department.toLowerCase();
                        break;
                    case 'amount':
                        aValue = a.amount;
                        bValue = b.amount;
                        break;
                    case 'date':
                        aValue = new Date(a.date);
                        bValue = new Date(b.date);
                        break;
                    default:
                        aValue = new Date(a.timestamp);
                        bValue = new Date(b.timestamp);
                }
                
                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            // 获取当前页数据
            const currentItems = getCurrentPageItems();
            
            // 更新表格
            if (currentItems.length === 0) {
                dataTable.innerHTML = `
                    <tr class="text-center">
                        <td colspan="7" class="py-12 text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-search text-4xl mb-2"></i>
                                <p>没有找到匹配的数据</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                dataTable.innerHTML = currentItems.map(item => `
                    <tr class="table-row">
                        <td class="table-cell">
                            <div class="flex items-center">
                                <input type="checkbox" data-id="${item.id}" class="row-checkbox h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="select-${item.id}" class="sr-only">选择 ${item.name}</label>
                            </div>
                        </td>
                        <td class="table-cell">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${formatDate(item.timestamp)}</div>
                                <div class="text-xs text-gray-500">${formatTime(item.timestamp)}</div>
                            </div>
                        </td>
                        <td class="table-cell">${item.name}</td>
                        <td class="table-cell">
                            <span class="badge badge-blue">${item.department}</span>
                        </td>
                        <td class="table-cell font-medium">¥${item.amount.toFixed(2)}</td>
                        <td class="table-cell">
                            ${item.fileName ? `
                                <a href="#" class="text-primary hover:text-primary/80 flex items-center" onclick="viewFile('${item.id}')">
                                    <i class="fa ${getFileIcon(item.fileType)} mr-1"></i>
                                    <span class="truncate max-w-[100px]">${item.fileName}</span>
                                </a>
                            ` : '<span class="text-gray-400">-</span>'}
                        </td>
                        <td class="table-cell">
                            <div class="flex space-x-2">
                                <button class="text-blue-600 hover:text-blue-800" onclick="editItem('${item.id}')">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800" onclick="deleteItem('${item.id}')">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                // 绑定行复选框事件
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const id = e.target.getAttribute('data-id');
                        if (e.target.checked) {
                            selectedItems.add(id);
                        } else {
                            selectedItems.delete(id);
                        }
                        
                        // 更新全选复选框状态
                        updateSelectAllStatus();
                        
                        // 显示或隐藏批量操作
                        toggleBatchActions();
                    });
                });
            }
            
            // 更新分页信息
            updatePagination();
            
            // 更新全选复选框状态
            updateSelectAllStatus();
        }

        // 应用搜索和筛选
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const departmentFilter = filterDepartment.value;
            
            return formData.filter(item => {
                // 搜索条件
                const matchesSearch = 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.department.toLowerCase().includes(searchTerm) ||
                    item.notes.toLowerCase().includes(searchTerm);
                
                // 部门筛选
                const matchesDepartment = !departmentFilter || item.department === departmentFilter;
                
                return matchesSearch && matchesDepartment;
            });
        }

        // 更新分页信息
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
            
            // 更新显示范围
            showingRangeSpan.textContent = filteredData.length > 0 ? 
                `${startIndex}-${endIndex}` : '0-0';
            
            // 更新总数
            totalCountSpan.textContent = filteredData.length;
            
            // 更新分页按钮状态
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // 更新全选复选框状态
        function updateSelectAllStatus() {
            const currentPageItems = getCurrentPageItems();
            if (currentPageItems.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            
            const checkedCount = currentPageItems.filter(item => 
                selectedItems.has(item.id)
            ).length;
            
            selectAllCheckbox.checked = checkedCount === currentPageItems.length;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < currentPageItems.length;
        }

        // 更新统计信息
        function updateStatistics() {
            // 总提交数
            totalSubmissionsSpan.textContent = formData.length;
            
            // 总金额
            const totalAmount = formData.reduce((sum, item) => sum + item.amount, 0);
            totalAmountSpan.textContent = `¥${totalAmount.toFixed(2)}`;
            
            // 部门数
            const departments = new Set(formData.map(item => item.department));
            departmentCountSpan.textContent = departments.size;
            
            // 今日提交
            const today = new Date().toISOString().split('T')[0];
            const todayItems = formData.filter(item => item.date === today);
            todaySubmissionsSpan.textContent = todayItems.length;
            
            // 今日金额
            const todayAmount = todayItems.reduce((sum, item) => sum + item.amount, 0);
            todayAmountSpan.textContent = `总计 ¥${todayAmount.toFixed(2)}`;
            
            // 计算趋势（模拟数据，实际应用中可能需要从服务器获取历史数据）
            const lastWeekItems = formData.filter(item => {
                const itemDate = new Date(item.date);
                const today = new Date();
                const lastWeek = new Date(today);
                lastWeek.setDate(today.getDate() - 7);
                return itemDate < lastWeek;
            });
            
            const submissionTrend = formData.length > 0 && lastWeekItems.length > 0 ?
                Math.round(((formData.length - lastWeekItems.length) / lastWeekItems.length) * 100) : 0;
            
            submissionTrendSpan.innerHTML = submissionTrend >= 0 ? 
                `<i class="fa fa-arrow-up mr-1"></i> ${submissionTrend}%` : 
                `<i class="fa fa-arrow-down mr-1"></i> ${Math.abs(submissionTrend)}%`;
            
            submissionTrendSpan.className = submissionTrend >= 0 ? 
                'text-sm font-medium text-green-600' : 
                'text-sm font-medium text-red-600';
            
            // 金额趋势
            const lastWeekAmount = lastWeekItems.reduce((sum, item) => sum + item.amount, 0);
            const amountTrend = totalAmount > 0 && lastWeekAmount > 0 ?
                Math.round(((totalAmount - lastWeekAmount) / lastWeekAmount) * 100) : 0;
            
            amountTrendSpan.innerHTML = amountTrend >= 0 ? 
                `<i class="fa fa-arrow-up mr-1"></i> ${amountTrend}%` : 
                `<i class="fa fa-arrow-down mr-1"></i> ${Math.abs(amountTrend)}%`;
            
            amountTrendSpan.className = amountTrend >= 0 ? 
                'text-sm font-medium text-green-600' : 
                'text-sm font-medium text-red-600';
        }

        // 初始化图表
        function initCharts() {
            // 部门分布图
            const departmentCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(departmentCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#3b82f6', // blue
                            '#10b981', // green
                            '#f59e0b', // yellow
                            '#ef4444', // red
                            '#8b5cf6', // purple
                            '#ec4899', // pink
                            '#6b7280', // gray
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        }
                    }
                }
            });
            
            // 金额趋势图
            const amountCtx = document.getElementById('amountChart').getContext('2d');
            amountChart = new Chart(amountCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '每日金额',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    }
                }
            });
            
            // 更新图表数据
            updateCharts();
        }

        // 更新图表
        function updateCharts() {
            // 更新部门分布图
            updateDepartmentChart();
            
            // 更新金额趋势图
            updateAmountChart();
        }

        // 更新部门分布图
        function updateDepartmentChart() {
            // 按部门分组并计数
            const departmentCounts = {};
            formData.forEach(item => {
                departmentCounts[item.department] = (departmentCounts[item.department] || 0) + 1;
            });
            
            // 准备图表数据
            const labels = Object.keys(departmentCounts);
            const data = Object.values(departmentCounts);
            
            // 更新图表
            departmentChart.data.labels = labels;
            departmentChart.data.datasets[0].data = data;
            departmentChart.update();
        }

        // 更新金额趋势图
        function updateAmountChart() {
            // 获取最近7天的日期
            const dates = [];
            const amounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dates.push(formatShortDate(dateStr));
                
                // 计算当天的总金额
                const dayAmount = formData
                    .filter(item => item.date === dateStr)
                    .reduce((sum, item) => sum + item.amount, 0);
                
                amounts.push(dayAmount);
            }
            
            // 更新图表
            amountChart.data.labels = dates;
            amountChart.data.datasets[0].data = amounts;
            amountChart.update();
        }

        // 保存表单数据
        function saveFormData() {
            try {
                localStorage.setItem('invoiceFormData', JSON.stringify(formData));
            } catch (error) {
                console.error('保存数据失败:', error);
            }
        }

        // 导出数据
        function exportData(format, data = filteredData) {
            if (data.length === 0) {
                alert('没有数据可导出');
                return;
            }
            
            // 准备CSV数据
            const headers = ['提交时间', '姓名', '部门', '金额', '提交日期', '备注', '文件名'];
            const csvContent = [
                headers.join(','), // 表头
                ...data.map(item => [
                    formatDateTime(item.timestamp),
                    item.name,
                    item.department,
                    item.amount.toFixed(2),
                    item.date,
                    `"${item.notes.replace(/"/g, '""')}"`, // 处理引号
                    item.fileName
                ].join(','))
            ].join('\n');
            
            // 创建Blob对象
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // 创建下载链接
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `发票数据_${formatDate(new Date())}.${format}`);
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            
            // 清理
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // 查看文件（模拟）
        function viewFile(id) {
            const item = formData.find(item => item.id === id);
            if (item && item.fileName) {
                alert(`查看文件: ${item.fileName}\n\n注意: 这是一个模拟功能，实际应用中可能需要从服务器获取文件。`);
            }
        }

        // 编辑项目（模拟）
        function editItem(id) {
            alert(`编辑项目 ID: ${id}\n\n注意: 这是一个模拟功能，实际应用中可能需要打开编辑表单。`);
        }

        // 删除项目
        function deleteItem(id) {
            if (confirm('确定要删除这条记录吗？此操作不可恢复。')) {
                // 从数据中删除
                formData = formData.filter(item => item.id !== id);
                
                // 从选中项中移除
                selectedItems.delete(id);
                
                // 保存到本地存储
                saveFormData();
                
                // 重新渲染数据
                renderData();
                
                // 更新统计信息
                updateStatistics();
                
                // 更新图表
                updateCharts();
                
                // 显示或隐藏批量操作
                toggleBatchActions();
            }
        }

        // 格式化日期 (YYYY-MM-DD)
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toISOString().split('T')[0];
        }

        // 格式化短日期 (MM-DD)
        function formatShortDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}-${date.getDate()}`;
        }

        // 格式化时间 (HH:MM)
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toTimeString().slice(0, 5);
        }

        // 格式化日期时间
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return `${formatDate(date)} ${formatTime(date)}`;
        }

        // 获取文件图标
        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return 'fa-file-pdf-o text-red-500';
            if (fileType.includes('image')) return 'fa-file-image-o text-green-500';
            return 'fa-file-o';
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>